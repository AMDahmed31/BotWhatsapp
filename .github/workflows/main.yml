name: Build Android APK

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-apk:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v3

    - name: ðŸ Setup Python 3.9
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: ðŸ’¾ Create 16GB Swap Space
      run: |
        echo "Creating swap space..."
        sudo fallocate -l 16G /swapfile
        sudo chmod 600 /swapfile
        sudo mkswap /swapfile
        sudo swapon /swapfile
        echo "Swap space created:"
        sudo swapon --show
        free -h

    - name: ðŸ“¦ Install System Dependencies
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y \
          build-essential \
          git \
          ffmpeg \
          libsdl2-dev \
          libsdl2-image-dev \
          libsdl2-mixer-dev \
          libsdl2-ttf-dev \
          libportmidi-dev \
          libswscale-dev \
          libavformat-dev \
          libavcodec-dev \
          zlib1g-dev \
          libgstreamer1.0-0 \
          gstreamer1.0-plugins-base \
          gstreamer1.0-plugins-good \
          libgstreamer1.0-dev \
          openjdk-11-jdk \
          unzip \
          autoconf \
          libtool \
          pkg-config \
          cmake \
          ninja-build

    - name: â˜• Configure Java Environment
      run: |
        echo "JAVA_HOME=/usr/lib/jvm/java-11-openjdk-amd64" >> $GITHUB_ENV
        echo "/usr/lib/jvm/java-11-openjdk-amd64/bin" >> $GITHUB_PATH
        java -version

    - name: ðŸ”§ Install Python Build Tools
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install --upgrade cython==0.29.36
        pip install buildozer==1.5.0
        pip install kivy==2.3.0
        pip install kivymd==1.1.1
        pip install pillow requests

    - name: âœ… Verify Buildozer Installation
      run: |
        which buildozer
        buildozer --version
        chmod +x $(which buildozer)

    - name: ðŸ—ï¸ Build APK with Buildozer
      run: |
        echo "================================"
        echo "ðŸ”¨ Starting APK Build Process"
        echo "================================"
        buildozer -v android debug
      env:
        BUILDOZER_WARN_ON_ROOT: 1

    - name: ðŸ” Search for APK Files
      if: always()
      run: |
        echo ""
        echo "=========================================="
        echo "ðŸ” SEARCHING FOR APK FILES"
        echo "=========================================="
        echo ""
        
        APK_FILES=$(find . -name "*.apk" -type f 2>/dev/null)
        
        if [ -n "$APK_FILES" ]; then
          echo "âœ… APK FILES FOUND:"
          echo "$APK_FILES"
          echo ""
          echo "ðŸ“Š File Details:"
          find . -name "*.apk" -type f -exec ls -lh {} \;
        else
          echo "âŒ NO APK FILES FOUND"
        fi
        
        echo ""
        echo "=========================================="
        echo "ðŸ“‚ CHECKING DIRECTORIES"
        echo "=========================================="
        
        if [ -d "bin" ]; then
          echo "âœ… bin/ directory exists:"
          ls -lah bin/
        else
          echo "âŒ bin/ directory NOT found"
        fi
        
        echo ""
        
        if [ -d ".buildozer" ]; then
          echo "âœ… .buildozer/ directory exists"
          echo "Searching for APKs in .buildozer/..."
          find .buildozer -name "*.apk" -type f 2>/dev/null | head -10 || echo "No APKs found"
        else
          echo "âŒ .buildozer/ directory NOT found"
        fi
        
        echo ""
        echo "=========================================="
        echo "ðŸ’¾ DISK SPACE"
        echo "=========================================="
        df -h

    - name: ðŸ“‹ Copy APK to Output Directory
      if: success()
      run: |
        mkdir -p apk-output
        find . -name "*.apk" -type f -exec cp -v {} apk-output/ \; 2>/dev/null || true
        echo ""
        echo "Files in apk-output/:"
        ls -lah apk-output/ 2>/dev/null || echo "No files copied"

    - name: ðŸ“¤ Upload APK Artifact
      uses: actions/upload-artifact@v3
      if: success()
      with:
        name: BotWhatsapp-APK
        path: |
          apk-output/*.apk
          bin/*.apk
          .buildozer/android/platform/build-*/dists/*/build/outputs/apk/**/*.apk
        if-no-files-found: warn
        retention-days: 30

    - name: ðŸ“¤ Upload APK (Fallback)
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: All-APK-Files
        path: '**/*.apk'
        if-no-files-found: ignore
        retention-days: 7

    - name: ðŸ“Š Build Summary
      if: always()
      run: |
        echo "# ðŸ“± Build Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Project:** BotWhatsapp Android APK" >> $GITHUB_STEP_SUMMARY
        echo "**Date:** $(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        APK_COUNT=$(find . -name "*.apk" -type f 2>/dev/null | wc -l)
        
        if [ "$APK_COUNT" -gt 0 ]; then
          echo "## âœ… Build Status: SUCCESS" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**APK Files Generated:** $APK_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ APK Locations:" >> $GITHUB_STEP_SUMMARY
          find . -name "*.apk" -type f -exec echo "- \`{}\`" \; >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¥ Download" >> $GITHUB_STEP_SUMMARY
          echo "Go to **Actions** tab â†’ Click this run â†’ Download from **Artifacts**" >> $GITHUB_STEP_SUMMARY
        else
          echo "## âŒ Build Status: FAILED" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "No APK file was generated. Check the build logs." >> $GITHUB_STEP_SUMMARY
        fi
